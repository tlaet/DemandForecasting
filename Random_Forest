# Importando bibliotecas necessárias
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from datetime import timedelta

# Carregando os dados históricos
df = pd.read_excel("dados_historicos.xlsx", sheet_name="Planilha1")

# Convertendo a coluna 'Data' para o formato datetime
df['Data'] = pd.to_datetime(df['Data'], format='%d/%m/%Y')

# Criando características adicionais para o modelo (ex: dia da semana, mês, ano)
df['DiaSemana'] = df['Data'].dt.dayofweek
df['Mes'] = df['Data'].dt.month
df['Ano'] = df['Data'].dt.year

# Criando e treinando o modelo Random Forest
modelo_rf = RandomForestRegressor(n_estimators=100, random_state=42)
modelo_rf.fit(df[['DiaSemana', 'Mes', 'Ano']], df['Vendas'])

# Criando datas para os próximos 2 anos (mensais)
data_inicio = df['Data'].max() + timedelta(days=1)
data_fim = data_inicio + timedelta(days=365 * 2)
datas_previsao = pd.date_range(start=data_inicio, end=data_fim, freq='MS')  # MS: mensal

# Criando características para as datas de previsão
dados_previsao = pd.DataFrame({
    'Data': datas_previsao,
    'DiaSemana': datas_previsao.dayofweek,
    'Mes': datas_previsao.month,
    'Ano': datas_previsao.year
})

# Fazendo a previsão mensal
previsao_vendas = modelo_rf.predict(dados_previsao[['DiaSemana', 'Mes', 'Ano']])

# Criando um DataFrame com os resultados
df_previsao = pd.DataFrame({
    'Data': datas_previsao,
    'Vendas_Previstas': previsao_vendas
})

# Unindo os dados históricos com os dados previstos
df_resultado = pd.concat([df, df_previsao], ignore_index=True)

# Salvando o resultado em um arquivo "previsao.xlsx"
df_resultado.to_excel("previsao.xlsx", index=False)

# Exibindo uma pré-visualização do arquivo de saída
df_resultado.tail(30)
